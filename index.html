<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Aumento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .progress-ring { transition: stroke-dashoffset 0.5s ease; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .btn-active:active { transform: scale(0.95); transition: 0.1s; }
        .page { display: none; }
        .page.active { display: block; }
        .viewport-overlay { box-shadow: 0 0 0 9999px rgba(15, 23, 42, 0.75); border: 2px solid #10b981; }
    </style>
</head>
<body class="font-sans antialiased pb-24">

    <div id="onboarding-screen" class="hidden fixed inset-0 z-[200] bg-slate-950 flex flex-col p-8 justify-center items-center text-center">
        <div class="w-full max-w-sm space-y-8">
            <div class="space-y-2">
                <h1 class="text-4xl font-black text-emerald-400 italic tracking-tighter">AUMENTO</h1>
                <p class="text-slate-500 uppercase text-[10px] tracking-[0.3em] font-bold">Cloud Sync Setup</p>
            </div>
            <div class="glass p-8 rounded-[3rem] space-y-6 border-emerald-500/20">
                <div class="space-y-4 text-left">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">Adafruit Username</label>
                        <input id="setup-user" type="text" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl mt-1 outline-none text-white focus:border-emerald-500" placeholder="Username">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">Adafruit IO Key</label>
                        <input id="setup-key" type="password" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl mt-1 outline-none text-white focus:border-emerald-500" placeholder="aio_abc123...">
                    </div>
                </div>
                <button onclick="saveOnboarding()" class="w-full bg-emerald-500 text-slate-950 font-black py-5 rounded-3xl btn-active uppercase italic shadow-xl shadow-emerald-500/10">Initialize Cloud</button>
            </div>
        </div>
    </div>

    <header class="p-6 pt-12 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-black tracking-tight text-emerald-400 italic">AUMENTO</h1>
            <p id="today-date" class="text-slate-400 text-sm italic uppercase tracking-widest font-bold"></p>
        </div>
        <button onclick="toggleSettings()" class="p-2 rounded-full glass btn-active"><i data-lucide="settings" class="w-6 h-6 text-white"></i></button>
    </header>

    <main id="dashboard-page" class="page active px-6 space-y-8 text-center">
        <div class="relative flex items-center justify-center py-4">
            <svg class="w-56 h-56">
                <circle class="text-slate-800" stroke-width="12" stroke="currentColor" fill="transparent" r="90" cx="112" cy="112" />
                <circle id="calorie-ring" class="text-emerald-500 progress-ring" stroke-width="12" stroke-dasharray="565" stroke-dashoffset="565" stroke-linecap="round" stroke="currentColor" fill="transparent" r="90" cx="112" cy="112" />
            </svg>
            <div class="absolute">
                <span class="block text-5xl font-black tracking-tighter" id="current-cal">0</span>
                <span class="text-[10px] text-slate-500 font-black uppercase tracking-[0.2em]" id="goal-display">/ 2800 KCAL</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 text-left">
            <div class="glass p-5 rounded-[2rem]">
                <div class="flex items-center gap-2 mb-1 text-blue-400">
                    <i data-lucide="droplet" class="w-4 h-4"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">Hydration</span>
                </div>
                <p class="text-2xl font-black text-white"><span id="water-count">0</span><span class="text-sm font-medium text-slate-500"> / 4</span></p>
                <p class="text-[10px] text-slate-500 font-bold" id="bottle-size-label">32oz bottles</p>
            </div>
            <div class="glass p-5 rounded-[2rem]">
                <div class="flex items-center gap-2 mb-1 text-orange-400">
                    <i data-lucide="zap" class="w-4 h-4"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">Protein</span>
                </div>
                <p class="text-2xl font-black text-white"><span id="protein-count">0</span><span class="text-sm font-medium text-slate-500"> / 100g</span></p>
                <p class="text-[10px] text-slate-500 font-bold uppercase">Daily Goal</p>
            </div>
        </div>

        <div class="space-y-4">
            <button onclick="openLogChoice()" class="w-full bg-emerald-500 text-slate-950 font-black text-lg py-5 rounded-3xl btn-active uppercase italic tracking-tighter">Log Real Meal</button>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="manualLog('shake')" class="glass py-5 rounded-3xl flex flex-col items-center gap-2 btn-active">
                    <i data-lucide="cup-soda" class="w-6 h-6 text-orange-400"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">Log Shake</span>
                </button>
                <button onclick="confirmWater()" class="glass py-5 rounded-3xl flex flex-col items-center gap-2 btn-active">
                    <i data-lucide="droplets" class="w-6 h-6 text-blue-400"></i>
                    <span class="text-[10px] font-black uppercase tracking-widest">Log Water</span>
                </button>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 p-6 z-40">
        <div class="glass max-w-xs mx-auto rounded-full flex justify-around p-2 border-white/20">
            <button onclick="showPage('dashboard')" id="nav-dashboard" class="p-3 rounded-full bg-emerald-500 text-slate-950"><i data-lucide="home" class="w-6 h-6"></i></button>
            <button onclick="showPage('progress')" id="nav-progress" class="p-3 rounded-full text-slate-400"><i data-lucide="bar-chart-2" class="w-6 h-6"></i></button>
        </div>
    </nav>

    <div id="log-choice-modal" class="hidden fixed inset-0 z-[60] flex items-end p-6 bg-slate-950/80 backdrop-blur-sm">
        <div class="glass w-full rounded-[3rem] p-8 space-y-4">
            <button onclick="startCamera()" class="w-full bg-white text-black font-black py-5 rounded-2xl flex items-center justify-center gap-3 btn-active uppercase tracking-tight"><i data-lucide="camera" class="w-6 h-6"></i> AI Vision Scan</button>
            <button onclick="openManualEntry()" class="w-full bg-slate-800 text-white font-black py-5 rounded-2xl flex items-center justify-center gap-3 btn-active uppercase tracking-tight"><i data-lucide="edit-3" class="w-6 h-6 text-emerald-400"></i> Manual Entry</button>
            <button onclick="closeModals()" class="w-full py-4 text-slate-500 font-bold uppercase text-[10px] tracking-widest">Cancel</button>
        </div>
    </div>

    <div id="camera-viewport" class="hidden fixed inset-0 z-[100] bg-black">
        <video id="video" class="w-full h-full object-cover" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-72 h-72 viewport-overlay rounded-[2.5rem]"></div>
        </div>
        <div class="absolute bottom-12 left-0 right-0 flex justify-around items-center px-10">
            <button onclick="stopCamera()" class="text-white bg-slate-900/50 p-4 rounded-full glass"><i data-lucide="x"></i></button>
            <button onclick="captureImage()" class="w-20 h-20 bg-white rounded-full border-4 border-emerald-500 btn-active shadow-2xl"></button>
            <div class="w-12 h-12"></div>
        </div>
    </div>

    <div id="manual-entry-modal" class="hidden fixed inset-0 z-[70] bg-slate-950 p-6 flex items-center justify-center">
        <div class="glass w-full max-w-sm p-8 rounded-[3rem] space-y-6">
            <h2 class="text-2xl font-black italic text-emerald-400 uppercase text-center">New Log</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">Food Name</label>
                    <input id="food-name" type="text" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl mt-1 text-white outline-none" placeholder="e.g. Grilled Chicken">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">Calories</label>
                        <input id="food-cal" type="number" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl mt-1 text-white outline-none" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest ml-2">Protein</label>
                        <input id="food-prot" type="number" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl mt-1 text-white outline-none" placeholder="0">
                    </div>
                </div>
            </div>
            <button onclick="submitManualEntry()" class="w-full bg-emerald-500 text-slate-950 font-black py-5 rounded-3xl btn-active uppercase italic shadow-lg">Save Log</button>
            <button onclick="closeModals()" class="w-full text-slate-500 font-bold py-2 uppercase tracking-widest text-[10px] text-center">Cancel</button>
        </div>
    </div>

    <script>
    lucide.createIcons();
    document.getElementById('today-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });

    let state = {
        calories: parseInt(localStorage.getItem('calories')) || 0,
        protein: parseInt(localStorage.getItem('protein')) || 0,
        water: parseInt(localStorage.getItem('water')) || 0,
        goal: parseInt(localStorage.getItem('goal')) || 2800,
        bottleSize: parseInt(localStorage.getItem('bottleSize')) || 32
    };

    // --- CLOUD SYNC LOGIC ---

    async function sendToAdafruit(feedName, value) {
        const user = localStorage.getItem('adafruit_user');
        const key = localStorage.getItem('adafruit_key');
        if (!user || !key) return;

        const url = `https://io.adafruit.com/api/v2/${user}/feeds/${feedName}/data`;
        try {
            await fetch(url, {
                method: 'POST',
                headers: { 'X-AIO-Key': key, 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: value })
            });
            console.log(`Cloud Sync: ${feedName} -> ${value}`);
        } catch (err) { console.error("Sync failed:", err); }
    }

    async function fetchFromAdafruit(feedName) {
        const user = localStorage.getItem('adafruit_user');
        const key = localStorage.getItem('adafruit_key');
        const url = `https://io.adafruit.com/api/v2/${user}/feeds/${feedName}/data/last`;
        try {
            const response = await fetch(url, { headers: { 'X-AIO-Key': key } });
            const data = await response.json();
            return data.value || 0;
        } catch (err) { return 0; }
    }

    async function syncAllData() {
        state.calories = parseInt(await fetchFromAdafruit('calories')) || 0;
        state.protein = parseInt(await fetchFromAdafruit('protein')) || 0;
        state.water = parseInt(await fetchFromAdafruit('water')) || 0;
        updateUI();
    }

    // --- APP LOGIC ---

    function updateUI() {
        document.getElementById('current-cal').innerText = state.calories.toLocaleString();
        document.getElementById('protein-count').innerText = state.protein;
        document.getElementById('water-count').innerText = state.water;
        document.getElementById('goal-display').innerText = `/ ${state.goal} KCAL`;
        
        const ring = document.getElementById('calorie-ring');
        const percent = Math.min((state.calories / state.goal) * 100, 100);
        ring.style.strokeDashoffset = 565 - (565 * (percent / 100));

        localStorage.setItem('calories', state.calories);
        localStorage.setItem('protein', state.protein);
        localStorage.setItem('water', state.water);
    }

    function confirmWater() {
        if (confirm(`Log 1 full ${state.bottleSize}oz bottle?`)) {
            state.water++;
            updateUI();
            sendToAdafruit('water', state.water);
            sendToAdafruit('food-log', `Drank ${state.bottleSize}oz Water`);
        }
    }

    function manualLog(type) {
        const cal = prompt(`Enter ${type} calories:`, type === 'shake' ? "1000" : "");
        const prot = prompt(`Enter ${type} protein (g):`, type === 'shake' ? "50" : "");
        if (cal) state.calories += parseInt(cal);
        if (prot) state.protein += parseInt(prot);
        updateUI();
        sendToAdafruit('calories', state.calories);
        sendToAdafruit('protein', state.protein);
        sendToAdafruit('food-log', type === 'shake' ? "Mass Gainer Shake" : "Manual Entry");
    }

    function submitManualEntry() {
        const name = document.getElementById('food-name').value || "Manual Entry";
        const c = document.getElementById('food-cal').value;
        const p = document.getElementById('food-prot').value;
        if(c) state.calories += parseInt(c);
        if(p) state.protein += parseInt(p);
        
        sendToAdafruit('calories', state.calories);
        sendToAdafruit('protein', state.protein);
        sendToAdafruit('food-log', name);
        
        closeModals();
        updateUI();
    }

    async function analyzeImage(imageData) {
        let API_KEY = localStorage.getItem('gemini_api_key');
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const promptText = "Identify the food. If NOT food, respond {'food': 'not food', 'calories': 0, 'protein': 0}. If food, estimate. Respond ONLY JSON: {'food': 'name', 'calories': 0, 'protein': 0}";

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }, { inline_data: { mime_type: "image/jpeg", data: imageData.split(',')[1] } }] }] })
            });
            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            const result = JSON.parse(text.replace(/```json|```/g, "").trim());

            if (result.food === "not food") return alert("No food detected.");

            if (confirm(`Log ${result.food}? (${result.calories} kcal)`)) {
                state.calories += result.calories;
                state.protein += result.protein;
                updateUI();
                sendToAdafruit('calories', state.calories);
                sendToAdafruit('protein', state.protein);
                sendToAdafruit('food-log', result.food);
            }
        } catch (e) { alert("AI Error. Check API Key."); }
    }

    // Camera and UI Helpers
    function saveOnboarding() {
        localStorage.setItem('adafruit_user', document.getElementById('setup-user').value.trim());
        localStorage.setItem('adafruit_key', document.getElementById('setup-key').value.trim());
        location.reload();
    }

    window.addEventListener('load', () => {
        if (!localStorage.getItem('adafruit_user')) document.getElementById('onboarding-screen').classList.remove('hidden');
        else syncAllData();
    });

    function showPage(p) { 
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById(p + '-page').classList.add('active');
    }
    function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
    function openLogChoice() { document.getElementById('log-choice-modal').classList.remove('hidden'); }
    function closeModals() { document.querySelectorAll('#log-choice-modal, #manual-entry-modal').forEach(m => m.classList.add('hidden')); }
    function openManualEntry() { closeModals(); document.getElementById('manual-entry-modal').classList.remove('hidden'); }

    let stream = null;
    async function startCamera() {
        closeModals();
        document.getElementById('camera-viewport').classList.remove('hidden');
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('video').srcObject = stream;
    }
    function stopCamera() { if(stream) stream.getTracks().forEach(t => t.stop()); document.getElementById('camera-viewport').classList.add('hidden'); }
    function captureImage() {
        const canvas = document.getElementById('canvas');
        canvas.width = 500; canvas.height = 500;
        canvas.getContext('2d').drawImage(document.getElementById('video'), 0, 0, 500, 500);
        stopCamera();
        analyzeImage(canvas.toDataURL('image/jpeg', 0.8));
    }
    </script>
</body>
</html>
